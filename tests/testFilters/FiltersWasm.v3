component IProc {
    private var imgProc: ImgProc;
    def init(width: int, height: int, channels: u8) {
        imgProc = ImgProc.new(width, height, channels);
    }
    def grayscale(src: Vector<byte>) -> Vector<byte> { return imgProc.grayscale(src); }
}


def imgProc_gray() -> Pointer {
    var imgProc = ImgProc.new(8, 1, 3);
    var input: Array<byte> = [8, 2, 120, 23, 27, 221, 210, 124, 8, 2, 120, 23, 27, 221, 210, 124, 8, 2, 120, 23, 27, 221, 210, 124];

    return Pointer.atContents(imgProc.grayscale_wasm(input));
}

def imgProc_gray2(width: int, height: int, channels: u8) {
    var src: Array<byte> = [8, 2, 120, 23, 27, 221, 210, 124, 8, 2, 120, 23, 27, 221, 210, 124, 8, 2, 120, 23, 27, 221, 210, 124];
    var out = Array<byte>.new(width * height);
    var r: u8;
    var g: u8;
    var b: u8;
    var q: u8 = 0;
    var imageSize = width * height;
    var cn = channels;
    for (p = 0; p < imageSize; p++) {
        r = src[q + 0];
        g = src[q + 1];
        b = src[q + 2];
        // https://stackoverflow.com/a/596241/5843642
        out[p] = (r + r + r + b + g + g + g + g) >> 3;
        q += cn;
    }
}

def main() {}

export imgProc_gray;
export imgProc_gray2;
export imgproc_init = IProc.init;
export imgproc_grayscale = IProc.grayscale;